<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Tetris!</title>
    <style>
      * { padding: 0; margin: 0; }
      canvas { display: block; margin: 0 auto; }
      canvas:hover { cursor: pointer; }
    </style>
  </head>
  <body>
    <canvas id="myCanvas" width="514" height="642"></canvas>
    <script>

      var sqrsAcross = 16;
      var sqrsTall = 20;
      var cubeSide = 30;
      var border = 2;

      var canvas = document.getElementById("myCanvas");
      var ctx = canvas.getContext("2d");
      var canvasWidth = ((cubeSide + border) * sqrsAcross) + border;
      var canvasHeight = ((cubeSide + border) * sqrsTall) + border;;

      var upPressed = false;
      var downPressed = false;
      var leftPressed = false;
      var rightPressed = false;

      var rotateDelay = 0;
      var sideDelay = 0;
      var downDelay = 0;

      var pieceYGrid = 0;
      var pieceXGrid = Math.floor(Math.random() * 13)
      var pieceY = 2;
      var pieceX = (pieceXGrid) * (cubeSide + border) + border;
      var pieceTimer = 0;
      var piecePos = 0;

      var begun = false;
      var over = false;

      var long = {};
      long[0] = [[0,1],[1,1],[2,1],[3,1]];
      long[1] = [[2,0],[2,1],[2,2],[2,3]];
      long[2] = [[0,2],[1,2],[2,2],[3,2]];
      long[3] = [[1,0],[1,1],[1,2],[1,3]];
      long["symbol"] = "g";

      var ell1 = {};
      ell1[0] = [[1,0],[1,1],[1,2],[0,2]];
      ell1[1] = [[0,0],[0,1],[1,1],[2,1]];
      ell1[2] = [[1,0],[2,0],[1,1],[1,2]];
      ell1[3] = [[0,1],[1,1],[2,1],[2,2]];
      ell1["symbol"] = "o";

      var ell2 = {};
      ell2[0] = [[1,0],[1,1],[1,2],[2,2]];
      ell2[1] = [[0,1],[1,1],[2,1],[0,2]];
      ell2[2] = [[0,0],[1,0],[1,1],[1,2]];
      ell2[3] = [[2,0],[0,1],[1,1],[2,1]];
      ell2["symbol"] = "y";

      var square = {};
      square[0] = [[0,0],[1,0],[0,1],[1,1]];
      square[1] = [[0,0],[1,0],[0,1],[1,1]];
      square[2] = [[0,0],[1,0],[0,1],[1,1]];
      square[3] = [[0,0],[1,0],[0,1],[1,1]];
      square["symbol"] = "k";

      var zag1 = {};
      zag1[0] = [[1,1],[2,1],[0,2],[1,2]];
      zag1[1] = [[0,0],[0,1],[1,1],[1,2]];
      zag1[2] = [[1,0],[2,0],[0,1],[1,1]];
      zag1[3] = [[1,0],[1,1],[2,1],[2,2]];
      zag1["symbol"] = "p";

      var tee = {};
      tee[0] = [[0,1],[1,1],[2,1],[1,2]];
      tee[1] = [[1,0],[0,1],[1,1],[1,2]];
      tee[2] = [[1,0],[0,1],[1,1],[2,1]];
      tee[3] = [[1,0],[1,1],[1,2],[2,1]];
      tee["symbol"] = "r";

      var zag2 = {};
      zag2[0] = [[0,1],[1,1],[1,2],[2,2]];
      zag2[1] = [[1,0],[0,1],[1,1],[0,2]];
      zag2[2] = [[0,0],[1,0],[1,1],[2,1]];
      zag2[3] = [[2,0],[1,1],[2,1],[1,2]];
      zag2["symbol"] = "b";

      var pieces = [long, ell1, ell2, square, zag1, tee, zag2];
      var piece = pieces[Math.floor(Math.random() * 7)];

      var colors = {};
      colors["x"] = "#DDDDDD";
      colors["r"] = "red";
      colors["o"] = "orange";
      colors["y"] = "yellow";
      colors["g"] = "green";
      colors["b"] = "blue";
      colors["p"] = "purple";
      colors["k"] = "pink";

      var grid = [

        ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
        ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
        ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
        ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
        ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
        ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
        ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
        ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
        ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
        ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
        ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
        ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
        ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
        ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
        ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
        ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
        ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
        ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
        ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
        ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],

      ];

      function resetVars() {

        rotateDelay = 0;
        sideDelay = 0;
        downDelay = 0;

        pieceYGrid = 0;
        pieceXGrid = Math.floor(Math.random() * 13)
        pieceY = 2;
        pieceX = (pieceXGrid) * (cubeSide + border) + border;
        pieceTimer = 0;
        piecePos = 0;
        piece = pieces[Math.floor(Math.random() * 7)];


        grid = [

          ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
          ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
          ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
          ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
          ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
          ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
          ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
          ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
          ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
          ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
          ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
          ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
          ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
          ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
          ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
          ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
          ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
          ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
          ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],
          ["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"],

        ];

      }

      function play() {

        pieceTimer += 1;

        if (pieceTimer === 10) {
          pieceY += (cubeSide + border);
          pieceYGrid += 1;
          pieceTimer = 0;
        }

        pieceCheck("down");

        if (rotateDelay > 0) {
          rotateDelay -= 1;
        }

        if (sideDelay > 0) {
          sideDelay -= 1;
        }

        if (downDelay > 0) {
          downDelay -= 1;
        }

        if (leftPressed && sideDelay === 0) {
          pieceX -= (cubeSide + border);
          pieceXGrid -= 1;
          sideDelay = 3;
        };

        pieceCheck("left");

        if (rightPressed && sideDelay === 0) {
          pieceX += (cubeSide + border);
          pieceXGrid += 1;
          sideDelay = 3;
        };

        pieceCheck("right");

        if (downPressed && downDelay === 0) {
          pieceY += (cubeSide + border);
          pieceYGrid += 1;
          downDelay = 3;
        }

        pieceCheck("down");

        if (upPressed && piecePos < 3 && rotateDelay == 0) {
          piecePos += 1;
          rotateDelay = 3;
        } else if (upPressed & piecePos >= 3 && rotateDelay == 0) {
          piecePos = 0;
          rotateDelay = 3;
        }

        pieceCheck("rot");

        checkRows();

      }

      function drawGrid() {

        ctx.fillStyle = "orange";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        var x = 2;
        var y = 2;

        ctx.fillStyle = "#777777";
        ctx.fillRect(0, 0, (sqrsAcross*(cubeSide+2)+2), (sqrsTall*(cubeSide+2)+2));

        grid.forEach((row) => {

          row.forEach((square) => {

            ctx.fillStyle = colors[square];
            ctx.fillRect(x,y,cubeSide,cubeSide);
            x += cubeSide + 2;

          });

          y += cubeSide + 2;
          x = 2;
          drawPiece();

          if (!begun) {
            drawIntro();
          }

          if (over) {
            drawOutro();
          }

        });

      }

      function drawPiece() {
        if (over) {
          return;
        }
        if (!begun) {
          return;
        }
        ctx.fillStyle = colors[piece["symbol"]];
        for (let idx = 0; idx < 4; idx++) {
          let x = piece[piecePos][idx][0];
          let y = piece[piecePos][idx][1];
          ctx.fillRect(pieceX+(x*(cubeSide + border)), pieceY+(y*(cubeSide + border)), cubeSide, cubeSide);
        }
      }

      function drawIntro() {
        ctx.fillStyle = "#4B0082";
        ctx.fillRect((cubeSide+border)*4+border, (cubeSide+border)*6+border, 254, 190);
        ctx.font = '48px sans-serif';
        ctx.fillStyle = "white"
        //width = 171; half width = about 85; height = 48; half height = 24;
        // canvas width="514" height="642"

        ctx.fillText('TETRIS', 172, 297);

        ctx.font = '18px sans-serif';
        //width: 100;
        ctx.fillText('Click to play!', 207, 335);
      }

      function drawOutro() {
        ctx.fillStyle = "#4B0082";
        ctx.fillRect((cubeSide+border)*4+border, (cubeSide+border)*6+border, 254, 190);
        ctx.font = '39px sans-serif';
        ctx.fillStyle = "white"
        //width = 236; half width = about 118; height = 48; half height = 24;
        // canvas width="514" height="642"

        ctx.fillText('GAME OVER', 139, 297);

        ctx.font = '18px sans-serif';
        //width: 94;
        ctx.fillText('Play again?', 210, 335);
      }

      function pieceIntersecting() {
        let intersecting = false;
        for (let idx = 0; idx < 4; idx++) {
          let x = piece[piecePos][idx][0] + pieceXGrid;
          let y = piece[piecePos][idx][1] + pieceYGrid;
          if (y >= sqrsTall) {
            intersecting = true;
          } else if (x >= sqrsAcross) {
            intersecting = true;
          } else if (x < 0) {
            intersecting = true;
          } else if (grid[y][x] != "x") {
            intersecting = true;
          }
        }
        return intersecting;
      }

      function pieceCheck(direction) {
        if (pieceIntersecting()) {
          if (direction === "left") {
            pieceX += (cubeSide + border);
            pieceXGrid += 1;
          } else if (direction === "right") {
            pieceX -= (cubeSide + border);
            pieceXGrid -= 1;
          } else if (direction === "down") {
            pieceY -= (cubeSide + border);
            pieceYGrid -= 1;
            // only creates a new piece if move would intersect on the bottom
            pieceStop();
            newPiece();
          } else if (direction === "rot") {
            piecePos -= 1;
            if (piecePos < 0) {
              piecePos = 3;
            }
          }
        }
      }

      function pieceStop() {
        for (let idx = 0; idx < 4; idx++) {
          let x = piece[piecePos][idx][0] + pieceXGrid;
          let y = piece[piecePos][idx][1] + pieceYGrid;
          grid[y][x] = piece["symbol"];
        }
      }

      function newPiece() {
        drawPiece();
        pieceYGrid = 0;
        pieceXGrid = Math.floor(Math.random() * 13)
        pieceY = 2;
        pieceX = (pieceXGrid) * (cubeSide + border) + border;
        pieceTimer = 0;
        piecePos = 0;
        piece = pieces[Math.floor(Math.random() * 7)];
        if (pieceIntersecting()) {
          gameOver();
        }
      }

      function checkRows() {
        for (let row = 0; row < sqrsTall; row++) {
          let white = false;
          for (let col = 0; col < sqrsAcross; col++) {
            if (grid[row][col] === "x") {
              white = true;
            }
          }
          if (!white) {
            deleteRow(row);
          }
        }
      }

      function deleteRow(row) {
        grid.splice(row, 1);
        grid.unshift(["x","x","x","x","x","x","x","x","x","x","x","x","x","x","x","x"]);
      }

      function startGame() {
        document.removeEventListener("click", startGame);
        over = false;
        begun = true;
        playInterval = setInterval(play, 50);
        resetVars();
      }

      function gameOver() {
        over = true;
        clearInterval(playInterval);
        document.addEventListener("click", startGame, false);
      }

      function keyDownHandler(e) {
        if(e.keyCode == 39) {
          rightPressed = true;
        }
        else if(e.keyCode == 37) {
          leftPressed = true;
        }
        else if(e.keyCode == 38) {
          upPressed = true;
        }
        else if(e.keyCode == 40) {
          downPressed = true;
        }
      }

      function keyUpHandler(e) {
        if(e.keyCode == 39) {
          rightPressed = false;
        }
        else if(e.keyCode == 37) {
          leftPressed = false;
        }
        else if(e.keyCode == 38) {
          upPressed = false;
        }
        else if(e.keyCode == 40) {
          downPressed = false;
        }
      }

      document.addEventListener("click", startGame, false);
      document.addEventListener("keydown", keyDownHandler, false);
      document.addEventListener("keyup", keyUpHandler, false);

      drawInterval = setInterval(drawGrid, 50);

    </script>
  </body>
</html>
